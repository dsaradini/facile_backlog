{% extends "project_base.html" %}
{% load sekizai_tags %}

{% block title %}{% if object %}{% trans "Edit workload" %}{% else %}{% trans "Create workload" %}{% endif %}{% endblock %}

{% block content %}
	<ul class="breadcrumb">
		<li><a href="{% url "dashboard" %}"><i class="icon-home"></i></a>&nbsp;&nbsp;</li>
		<li class="divider"><div class="inner"></div></li>
		<li><a href="{% url "workload_list" %}">{% trans "Workloads" %}</a></li>
		<li class="divider"><div class="inner"></div></li>
		{% if object %}
			<li class="active">{% trans "Edit workload" %}</li>
		{% else %}
			<li class="active"><i>{% trans "Create workload" %}</i></li>
		{% endif %}
	</ul>

<div class="row">
	<div class="col-md-6  col-md-offset-3 base-form">
		{% if not object %}<h1>{% trans "Create workload" %}</h1>{% endif %}
		<form method="post" id="edit_workload_form" action="{% if object %}{% url "workload_edit" object.pk %}{% else %}{% url "workload_add" %}{% endif %}">
			{% include "form.html" %}
			<div class="submit">
				<input class="btn btn-success" type="submit" value="{% if object %}{% trans "Save changes" %}{% else %}{% trans "Create workload" %}{% endif %}">
				<a class="btn btn-link" href="{% url "workload_list" %}">{% trans "Cancel" %}</a>
			</div>
		</form>
	</div>
</div>
{% addtoblock "js" %}
<script type="text/javascript">
$(function() {
	$('#id_when').datepicker({
		format: "yyyy-mm-dd"
	}).on('changeDate', function(ev) {
  		$(this).datepicker('hide');
	});
	$('#id_when').on('blur', function() {
		var $this = $(this);
		setTimeout( function() {
			$this.datepicker('hide');
		},200);
	});

	var $source = $("#id_source");

	var server_data = null
	jQuery.ajax({
         url:    '{% url "api_workload_sources" %}',
         success: function(data) {
                      server_data = data.results
                  },
         async:   false
    });

	var format_project = function(data) {
		if (data.type == 'org') {
			return "<div>"+data.html_logo+" <b>"+data.name+"</b></div>"
		} else if (data.type == 'sep') {
			return "<div><b>"+data.title+"</b></div>"
		} else {
			return "<b class='select2-indent text-muted'>["+data.code+"]</b> "+data.name+""
		}
	};

	$source.select2({
		placeholder: "{% trans "Select project or user story" %}",
    	minimumInputLength: 0,
		data: server_data,
		formatResult: format_project,
		formatSelection: format_project,
		dropdownCssClass: "bigdrop", // apply css that makes the dropdown taller
		escapeMarkup: function (m) { return m; } // we do not want to escape markup since we are displaying html
	});
	$source.on("change", function(){
		setTimeout( function() {
			$('#id_amount').select();
		},10);
	});
	{% if project %}
		$('#id_amount').select();
	{% else %}
		if (!$source.val()) {
			$source.select2("open");
		}
	{% endif %}

});
</script>
{% endaddtoblock %}
{% endblock %}
{% extends "project_base.html" %}
{% load static sekizai_tags %}
{% block title %}{% trans "Project" %} &mdash; {{ project.name }} &mdash; {% trans "backlogs" %}{% endblock %}

{% block content_class %}project-backlogs{% endblock %}

{% block content %}

	{% include "backlog/_project_head.html" %}

	<ul class="nav nav-tabs">
		<li><a href="{% url "project_detail" project.pk %}">{% trans "General" %}</a></li>
		<li class="active"><a href="{% url "project_backlogs" project.pk %}">{% trans "Backlogs" %} </a></li>
		<li><a href="{% url "project_users" project.pk %}">{% trans "Members" %} </a>
		<li><a href="{% url "project_stories" project.pk %}">{% trans "Stories" %}</a></li>
	</ul>
	<form class="form-inline boxed">
		<label>{% trans "Highlight theme" %}</label>&nbsp;
		<select class="select" id="theme-select">
			<option value="">{% trans "No filter" %}</option>
			{% for theme in project.all_themes %}
				<option value="{{ theme }}">{{ theme }}</option>
			{% endfor %}
		</select>
		<a href=".">{% trans "Refresh" %}</a>
		<a class="btn btn-primary btn-small pull-right" href="{% url "project_backlog_create" project.pk %}">{% trans "Create backlog" %}</a>
	</form>
	<div class="backlog-lanes" style="width:{% widthratio backlog_list|length 1 320 %}px">
		{% for backlog in backlog_list %}
			<article class="{% if backlog.is_main %}main{% endif %} backlog" id="backlog-{{ backlog.pk }}" backlog-id="{{ backlog.pk }}">
				<div class="backlog-title">
					<div class="btn-group">
						<a class="btn btn-link dropdown-toggle padding-reset" href="#" data-toggle="dropdown">
							{{ backlog.name }}
							<span class="caret"></span>
						</a>
						<ul class="dropdown-menu">
							<li><a href="{% url "print_stories" %}?backlog_id={{ backlog.pk }}">{% trans "Print stories" %}</a></li>
							<li class="divider"></li>
							<li><a href="{% url "project_backlog_edit" project.pk backlog.pk %}?_back=project">{% trans "Edit" %}</a></li>
							<li><a href="{% url "project_backlog_delete" project.pk backlog.pk %}?_back=project">{% trans "Delete" %}</a></li>
						</ul>
					</div>
					<span class="muted small">({{ backlog.stats.total_stories }})</span>

					{% if backlog.is_main %}
						<span class="label label-inverse pull-right">{% trans "main" %}</span>
					{% else %}
						<a class="close pull-right close-lane" href="#">&times;</a>
					{% endif %}
				</div>
				<div class="stories" story-backlog-id="{{ backlog.pk }}">
					{% for story in backlog.ordered_stories %}
						<article theme-id="{{ story.theme }}" class="small-story" id="story-{{ story.pk }}" story-id="{{ story.pk }}">
							<div class="handle" style="background-color:{{ story.color }}"></div>
							<div class="handled">
								<div class="story-title">
									<div class="btn-group">
										<a class="btn btn-link dropdown-toggle padding-reset" href="#" data-toggle="dropdown">
											{{ story.code }}
											<span class="caret"></span>
										</a>
										<ul class="dropdown-menu">
											<li><a href="{% url "story_detail" project.pk story.pk %}">{% trans "Details" %}</a></li>
											<li><a href="{% url "story_edit" project.pk story.pk %}?_back=project">{% trans "Edit" %}</a></li>
											<li><a href="{% url "story_delete" project.pk story.pk %}?_back=project">{% trans "Delete" %}</a></li>

										</ul>
									</div>
								</div>
								<div class="points">
									{% if story.points >= 0%}
										{{ story.points|floatformat:"0" }}
									{% else %}
									&nbsp;
									{% endif %}
								</div>
								<div class="status">
									<div class="btn-group">
										<a class="btn btn-link dropdown-toggle padding-reset" href="#" data-toggle="dropdown">
											<span class="story-status" status={{ story.status }}>
												<i class="icon icon-circle"></i> <i class="icon-caret-down"></i>
											</span>
										</a>
										<ul class="dropdown-menu">
											{% for s in story.project.all_status %}
												<li><a onclick="javascript:set_story_status(this, {{ story.pk }}, '{{ s.0 }}')">{{ s.1 }}</a></li>
											{% endfor %}
										</ul>
									</div>
								</div>
								<div class="text">{% include "backlog/user_story_text.html" %}</div>
								{% if story.theme %}
									<div class="theme"><i class="icon-tag"></i> {{ story.theme }}</div>
								{% endif %}
							</div>
						</article>
					{%  endfor %}
				</div>
				<div class="backlog-action">
					<a href="{% url "story_create" project.pk backlog.pk %}?_back=project" class="btn btn-primary btn-small">{% trans "Add story" %}</a>
				</div>
			</article>
		{% endfor %}
	</div>
{% include "backlog/_script_status_change.html" %}
{% include "backlog/_script_show_errors.html" %}
{% addtoblock "js" %}
<script type="text/javascript" src="{% static "core/js/jquery.js" %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript" src="{% static "core/js/jquery.csrf.js" %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript" src="{% static "core/js/jquery-ui.custom.min.js" %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript" src="{% static "core/js/jquery.ws-notify.js" %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript">
	$(function() {

		// keep a clone of speakers to replace the cell
		// if an error occurs on server

		$('.backlog-lanes').sortable({
			placeholder: "backlog-place-holder",
			distance: 3,
			cursor: "move",
			revert: 100,
			update: function(event, ui) {
				$('.backlog-lanes').sortable("disable");
				var backlog_pk = ui.item.attr("backlog-id");
				var order = [];
				$('article[backlog-id]').each(function() {
					order.push(parseInt($(this).attr('backlog-id')));
				});
				$.ajax({
					url: '{% url "api_project_move_backlog" project.pk %}',
					type: "POST",
					contentType:"application/json; charset=utf-8",
					dataType: "json",
					data: JSON.stringify({
						moved_backlog: backlog_pk,
						order: order
					}),
					error: function( jqXHR, textStatus, errorThrown ){
						$.show_error( '{% trans "Server return an error."%}', jqXHR)
						$('.backlog-lanes').sortable( "cancel" );
					},
					success: function() {

					},
					complete: function(){
						$('.backlog-lanes').sortable("enable");
					}
				});
			}
		});

		$('.stories').sortable({
			connectWith: ".stories",
			placeholder: "story-place-holder",
			forcePlaceholderSize: true,
			distance: 3,
			cursor: "move",
			revert: 100,
			update: function(event, ui) {
				$('.stories').sortable("disable");
				var $this = $(this);
				var story_pk = ui.item.attr("story-id");
				var current_backlog_pk =  $this.attr("story-backlog-id");
				var from_backlog = ui.sender && ui.sender.attr("backlog-id");
				var ajax_data;
				if ( $this.find("[story-id="+story_pk+"]").length ) {
					var order = [];

					$this.find('[story-id]').each(function() {
						order.push(parseInt($(this).attr('story-id')));
					});
					ajax_data = {
						source_backlog: from_backlog,
						target_backlog: current_backlog_pk,
						moved_story: story_pk,
						order: order
					};
					// story is in the updated backlog
					if (from_backlog) {
						ajax_data.action = "move";
					} else {
						ajax_data.action = "order";
					}
				} else {
					// do not care, we will receive a update for move
				}
				if (ajax_data) {
					$.ajax({
						url: '{% url "api_move_story" %}',
						type: "POST",
						contentType:"application/json; charset=utf-8",
						dataType: "json",
						data: JSON.stringify(ajax_data),
						error: function( jqXHR, textStatus, errorThrown ){
							$.show_error( '{% trans "Server return an error."%}', jqXHR)
							$('.stories').sortable( "cancel" );
						},
						success: function() {

						},
						complete: function(){
							$('.stories').sortable("enable");
						}
					});
				} else {
					$('.stories').sortable("enable");
				}
			}
		});

		$(".filter").show(); // hidden by default, if scripting is disabled, they should not show
		$("#theme-select").change(function() {
			var theme_id = $(this).val();
			$(".filter-highlighted").removeClass("filter-highlighted");
			$(".filter-opacified").removeClass("filter-opacified");
			if (theme_id) {
				$("article[theme-id]").addClass("filter-opacified");
				$("article[theme-id='"+theme_id+"']").addClass("filter-highlighted").removeClass("filter-opacified")
			}
		});
		$(".close-lane").click(function() {
			$(this).parents("article.backlog").fadeOut()
		});

		$.ws_sbscribe({
			url: '{{ ws_url }}Project/{{ project.pk }}/',
			on_message: function(message) {
				if (message.type == "backlogs_moved") {
					var $parent = $(".backlog-lanes");
					for (var i in message.order) {
						var pk = message.order[i];
						var $article = $("article.backlog[backlog-id="+pk+"]");
						$parent.append($article);
					}
				} else if (message.type == "stories_moved") {
					console.log(message)
					var $parent = $("[story-backlog-id="+message.backlog_id+"]");
					for (var i in message.order) {
						var pk = message.order[i];
						var $article = $("article.small-story[story-id="+pk+"]");
						$parent.append($article);
					}
				}
			}
		})
	});
</script>
{% endaddtoblock %}
{% endblock %}
{% extends "base.html" %}
{% load static sekizai_tags %}
{% block title %}{% trans "Project" %} &mdash; {{ project.name }} &mdash; {% trans "backlogs" %}{% endblock %}

{% block content_class %}project-backlogs{% endblock %}

{% block content %}
	<div class="upper-bar">
		<div class="path">
			<a href="{%  url "home" %}"><i class="icon-home"></i>{% trans "Home" %}</a> <i class="sep icon-angle-right"></i>
			<i class="icon-book"></i> <span class="current">{{ project.name }}</span>
		</div>
		<div id="links">
			<span class="tab">
				<a href="{% url "project_detail" project.pk %}">{% trans "General" %} </a>
			</span>
			<span class="tab active">{% trans "Backlogs" %}</span>
			<span class="tab">
				<a href="{% url "project_users" project.pk %}">{% trans "Members" %} </a>
			</span>
			<span class="tab">
				<a href="{% url "project_stories" project.pk %}">{% trans "Stories" %}</a>
			</span>
		</div>
		{% include "backlog/_project_head.html" %}
	</div>

	<div class="backlog-list" style="width:{% widthratio backlog_list.count 1 320 %}px">
		{% for backlog in backlog_list %}
			<article class="backlog">
				<div class="backlog-title">
					<a href="{% url "backlog_detail" project.pk backlog.pk %}">{{ backlog.name }}</a>
					&nbsp;<a href="{% url "backlog_edit" project.pk backlog.pk %}?_back=project"><i class="icon-edit"></i></a>

				</div>
				<div class="stories" backlog-id="{{ backlog.pk }}">
					{% for story in backlog.ordered_stories %}
						<article class="small-story" story-id="{{ story.pk }}">
							<div class="handle"></div>
							<div class="handled">
								<div class="story-title">
									<a href="{% url "story_detail" project.pk story.pk %}">{{ story.code }}</a>
									&nbsp;<a href="{% url "story_edit" project.pk story.pk %}?_back=project"><i class="icon-edit"></i></a>
								</div>
								<div class="points">
									{% if story.points >= 0%}
										{{ story.points|floatformat:"0" }}
									{% else %}
									&mdash;
									{% endif %}
								</div>
								<div class="text">{% include "backlog/user_story_text.html" %}</div>
								<div class="theme">{{ story.theme }}</div>
							</div>
						</article>
					{%  endfor %}
				</div>
				<div class="backlog-action">
					<a href="{% url "story_create" project.pk backlog.pk %}?_back=project" class="button">{% trans "Add story" %}</a>
				</div>
			</article>
		{% endfor %}
	</div>
{% addtoblock "js" %}
<script type="text/javascript" src="{% static "core/js/jquery.js" %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript" src="{% static "core/js/jquery.csrf.js" %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript" src="{% static "core/js/jquery-ui.custom.min.js" %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript" src="{% static "core/js/dropit.js" %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript">
	$(function() {
		// keep a clone of speakers to replace the cell
		// if an error occurs on server

		var setup = function() {
			$('.stories').sortable({
				connectWith: ".stories",
				placeholder: "handle-highlight",
				forcePlaceholderSize: true,
				distance: 3,
				cursor: "move",
				handle: ".handle",
				revert: true,
				update: function(event, ui) {
					$('.stories').sortable("disable");
					var $this = $(this);
					var story_pk = ui.item.attr("story-id");
					var current_backlog_pk =  $this.attr("backlog-id");
					var from_backlog = ui.sender && ui.sender.attr("backlog-id");
					var ajax_data;
					if ( $this.find("[story-id="+story_pk+"]").length ) {
						var order = [];

						$this.find('[story-id]').each(function() {
							order.push(parseInt($(this).attr('story-id')));
						});
						ajax_data = {
							source_backlog: from_backlog,
							target_backlog: current_backlog_pk,
							moved_story: story_pk,
							order: order
						};
						// story is in the updated backlog
						if (from_backlog) {
							ajax_data.action = "move";
						} else {
							ajax_data.action = "order";
						}
					} else {
						// do not care, we will receive a update for move
					}
					if (ajax_data) {
						$.ajax({
							url: '{% url "api_move_story" project.pk %}',
							type: "POST",
							contentType:"application/json; charset=utf-8",
							dataType: "json",
							data: JSON.stringify(ajax_data),
							error: function( jqXHR, textStatus, errorThrown ){
								$("#messages").empty().append(
									$("<div>").addClass("error").text( '{% trans "Server return an error."%}' )
								);
								$('.stories').sortable( "cancel" );
							},
							success: function() {
								// replace the copy to be able to re-order again
								$stories_clone = $(".stories").clone(false);
							},
							complete: function(){
								$('.stories').sortable("enable");
							}
						});
					} else {
						$('.stories').sortable("enable");
					}
				}
			});
		};
		setup();
		$(".dropdown-button").dropit();

		$(".handle").show(); // hidden by default, if scripting is disabled, they should not show
	});
</script>
{% endaddtoblock %}
{% endblock %}
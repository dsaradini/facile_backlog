{% extends "base.html" %}
{% load staticfiles sekizai_tags markup acl %}

{% block title %}{% trans "Backlog" %} &mdash; {{ backlog.name }}{% endblock %}

{% block content %}
	<div class="path">
		<a href="{%  url "home" %}"><i class="icon-home"></i>{% trans "Home" %}</a> /
		<a href="{%  url "project_detail" project.pk %}"> <i class="icon-book"></i> {{ project.name }}</a> /
		<i class="icon-list-alt"></i><span class="current">{{ backlog.name }}</span>
	</div>
	<h1>{{ backlog.name }}</h1>
	<div class="description">
		{% if backlog.description %}
			{{ backlog.description|markdown }}
		{% endif %}
	</div>
	<div class="actions">
		{% if backlog|can_admin:request.user %}
			<a class="alt-button" href="{% url "backlog_edit" project.pk backlog.pk %}">{% trans "Edit" %}</a>
			<a class="alt-button" href="{% url "backlog_delete" project.pk backlog.pk %}">{% trans "Delete" %}</a>
		{% endif %}
	</div>
	<div class="poutre">
		<h2>{%  trans "User stories" %}</h2>
		<div class="actions">
		<a class="button" href="{% url "story_create" project.pk backlog.pk %}">
			<i class="icon-magic"></i>
			{% trans "Add user story" %}
		</a>
		</div>
		<span class="sub-field filter" style="display:none">{% trans "Highlight theme:" %}<select id="theme-select">
			<option value=""></option>
			{% for theme in backlog.all_themes %}
				<option value="{{ theme }}">{{ theme }}</option>
			{% endfor %}
		</select></span>
	</div>
	<div class="stories">
		{% for story in backlog.ordered_stories %}
			{% include "backlog/story_cell.html" %}
		{% empty %}
			{% trans "No stories" %}
		{% endfor %}
	</div>


{% addtoblock "js" %}
<script type="text/javascript" src="{% static "core/js/jquery.js" %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript" src="{% static "core/js/jquery.csrf.js" %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript" src="{% static "core/js/jquery-ui.custom.min.js" %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript" src="{% static "core/js/dropit.js" %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript">
	$(function() {
		// keep a clone of speakers to replace the cell
		// if an error occurs on server
		$(".handle").show(); // hidden by default, if scripting is disabled, they should not show
		var $stories_clone = $(".stories").clone(false);
		var setup = function() {
			$('.stories').sortable({
				placeholder: "handle-highlight",
				forcePlaceholderSize: true,
				distance: 3,
				cursor: "move",
				handle: ".handle",
				revert: true,
				update: function(event, ui) {
					var $this = $(this);
					$this.sortable("disable");
					var order = [];
					$('[data-id]').each(function() {
						order.push(parseInt($(this).attr('data-id')));
					});
					$.ajax({
						url: '{% url "backlog_story_reorder" project.pk backlog.pk %}',
						type: "POST",
						dataType: "json",
						data: JSON.stringify({order: order}),
						error: function( jqXHR, textStatus, errorThrown ){
							$("#messages").empty().append(
								$("<div>").addClass("error").text( '{% trans "Error while reordering elements."%}' )
							);
							$('.stories').replaceWith($stories_clone.clone());
							setup();
						},
						success: function() {
							// replace the copy to be able to re-order again
							$stories_clone = $(".stories").clone(false);
						},
						complete: function(){
							$this.sortable("enable");
						}
					});
				}
			});
		};
		setup();

		// handle selection of themes
		$(".filter").show(); // hidden by default, if scripting is disabled, they should not show
		$("#theme-select").change(function() {
			var theme_id = $(this).val();
			$(".highlighted").removeClass("highlighted");
			$(".opacified").removeClass("opacified");
			if (theme_id) {
				$("article").addClass("opacified");
				$("article[theme-id='"+theme_id+"']").addClass("highlighted").removeClass("opacified")
			}
		});

		$(".dropdown-button").dropit();
		$.move_story = function(story_pk, backlog_pk) {
			$.ajax({
				url: '{% url "story_move" project.pk %}',
				type: "POST",
				dataType: "json",
				data: JSON.stringify({
					story_id: story_pk,
					backlog_id: backlog_pk
				}),
				error: function( jqXHR, textStatus, errorThrown ){
					$("#messages").empty().append(
						$("<div>").addClass("error").text( '{% trans "Error while moving story."%}' )
					);
				},
				success: function() {
					$("[data-id="+story_pk+"]").fadeOut();
				}
			});
		}

		$(".status-button").dropit();
		$.change_story_status = function(story_pk, status) {
			$.ajax({
				url: '{% url "story_change_status" project.pk %}',
				type: "POST",
				dataType: "json",
				data: JSON.stringify({
					story_id: story_pk,
					new_status: status
				}),
				error: function( jqXHR, textStatus, errorThrown ){
					$("#messages").empty().append(
						$("<div>").addClass("error").text( '{% trans "Error while changing status."%}' )
					);
				},
				success: function(data) {
					$("[data-id="+story_pk+"] .current-status").text(data.new_status);
					$("[data-id="+story_pk+"] .status").attr('status', data.code);
				}
			});
		}
	});
</script>
{% endaddtoblock %}
{% endblock %}